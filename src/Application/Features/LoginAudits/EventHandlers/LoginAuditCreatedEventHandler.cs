//------------------------------------------------------------------------------
// <auto-generated>
// CleanArchitecture.Blazor - MIT Licensed.
// Author: neozhu
// Created/Modified: 2025-03-19
// Handles LoginAuditCreatedEvent: triggered when a new contact is created.
// Extendable for additional actions (e.g., notifications, system updates).
// </auto-generated>
//------------------------------------------------------------------------------


using CleanArchitecture.Blazor.Domain.Identity;
using DocumentFormat.OpenXml.Office2016.Drawing.ChartDrawing;

namespace CleanArchitecture.Blazor.Application.Features.LoginAudits.EventHandlers;

public class LoginAuditCreatedEventHandler : INotificationHandler<LoginAuditCreatedEvent>
{
    private readonly IGeolocationService _geolocationService;
    private readonly IApplicationDbContext _dbContext;
    private readonly ILogger<LoginAuditCreatedEventHandler> _logger;

        public LoginAuditCreatedEventHandler(
            IGeolocationService geolocationService,
            IApplicationDbContext dbContext,
            ILogger<LoginAuditCreatedEventHandler> logger
            )
        {
        _geolocationService = geolocationService;
        _dbContext = dbContext;
        _logger = logger;
        }
        public async Task Handle(LoginAuditCreatedEvent notification, CancellationToken cancellationToken)
        {
            _logger.LogInformation("Handled domain event '{EventType}' with notification: {@Notification} ", notification.GetType().Name, notification);

        if (!string.IsNullOrEmpty(notification.Item.IpAddress) && !notification.Item.IpAddress.StartsWith("127") && string.IsNullOrEmpty(notification.Item.Region))
        {
            var geolocation = await _geolocationService.GetGeolocationAsync(notification.Item.IpAddress, cancellationToken);
            if (geolocation != null) {
                var regionParts = new List<string>();

                if (!string.IsNullOrEmpty(geolocation.City))
                    regionParts.Add(geolocation.City);

                if (!string.IsNullOrEmpty(geolocation.Region))
                    regionParts.Add(geolocation.Region);

                if (!string.IsNullOrEmpty(geolocation.CountryName))
                    regionParts.Add(geolocation.CountryName);
                else if (!string.IsNullOrEmpty(geolocation.Country))
                    regionParts.Add(geolocation.Country);

                var region = regionParts.Count > 0 ? string.Join(", ", regionParts) : null;
                await _dbContext.LoginAudits.Where(x => x.Id == notification.Item.Id).ExecuteUpdateAsync(x => x.SetProperty(y => y.Region, region));
            }
        }
      
        }
}
